<template>
  <div class="min-h-screen bg-white flex flex-col">

    <div class="border-b border-gray-200 px-4 py-2 bg-white shadow-sm">
      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center space-x-4">
          <h1 class="text-xl font-semibold text-[#1A365D]">Â¢®‰∫ï</h1>
          <div class="flex items-center">
            <span 
              class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium"
              :class="isConnected.value ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
            >
              <span 
                class="w-2 h-2 mr-1 rounded-full"
                :class="isConnected.value ? 'bg-green-400' : 'bg-red-400'"
              ></span>
              {{ isConnected.value ? 'AI Â∑≤ËøûÊé•' : 'AI Êú™ËøûÊé•' }}
            </span>
          </div>
        </div>
        
        <div class="flex items-center">
          <!-- Â∑•ÂÖ∑ÁªÑ 1: ÊñáÊ°£Â∑•ÂÖ∑ -->
          <div class="flex items-center space-x-2 mr-4">
            <button
              @click="showVersionHistory = !showVersionHistory"
              :class="showVersionHistory ? 'bg-yellow-100 text-yellow-700 border-yellow-200' : 'text-gray-600 hover:text-gray-800 border-gray-200 hover:bg-gray-50'"
              class="flex items-center px-3 py-2 rounded-lg transition-colors duration-200 border text-sm"
              title="ÁâàÊú¨ÂéÜÂè≤"
            >
              <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              ÁâàÊú¨ÂéÜÂè≤
            </button>
            <button
              @click="showExportPanel = !showExportPanel"
              :class="showExportPanel ? 'bg-blue-100 text-blue-700 border-blue-200' : 'text-gray-600 hover:text-gray-800 border-gray-200 hover:bg-gray-50'"
              class="flex items-center px-3 py-2 rounded-lg transition-colors duration-200 border text-sm"
              title="ÂØºÂá∫ÊñáÊ°£"
            >
              <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              ÂØºÂá∫ÊñáÊ°£
            </button>
          </div>
          
          <!-- Â∑•ÂÖ∑ÁªÑ 2: Â≠¶ÊúØÂ∑•ÂÖ∑ -->
          <div class="flex items-center space-x-2 mr-4">
            <button
              @click="showCitationManager = !showCitationManager"
              :class="showCitationManager ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'text-gray-600 hover:text-gray-800 border-gray-200 hover:bg-gray-50'"
              class="flex items-center px-3 py-2 rounded-lg transition-colors duration-200 border text-sm"
              title="ÂºïÁî®ÁÆ°ÁêÜ"
            >
              <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              ÂºïÁî®ÁÆ°ÁêÜ
            </button>
            <button
              @click="showResearchPanel = !showResearchPanel"
              :class="showResearchPanel ? 'bg-green-100 text-green-700 border-green-200' : 'text-gray-600 hover:text-gray-800 border-gray-200 hover:bg-gray-50'"
              class="flex items-center px-3 py-2 rounded-lg transition-colors duration-200 border text-sm"
              title="Á†îÁ©∂Âä©Êâã"
            >
              <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
              Á†îÁ©∂Âä©Êâã
            </button>
          </div>
          
          <!-- Â∑•ÂÖ∑ÁªÑ 3: AI ÂíåÊ®°ÊùøÂ∑•ÂÖ∑ -->
          <div class="flex items-center space-x-2 mr-4">
            <button
              @click="showTemplatesPanel = !showTemplatesPanel"
              :class="showTemplatesPanel ? 'bg-purple-100 text-purple-700 border-purple-200' : 'text-gray-600 hover:text-gray-800 border-gray-200 hover:bg-gray-50'"
              class="flex items-center px-3 py-2 rounded-lg transition-colors duration-200 border text-sm"
              title="ÊñáÊ°£Ê®°Êùø"
            >
              <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              ÊñáÊ°£Ê®°Êùø
            </button>
          </div>
          
          <!-- ÂºÄÂßãÂÜô‰ΩúÊåâÈíÆ -->
          <button
            @click="showOutlineGenerator = true"
            class="px-4 py-2 bg-[#4FD1C5] text-white rounded-lg hover:bg-[#3DB9B0] transition-colors font-medium mr-4"
          >
            üöÄ ÂºÄÂßãÂÜô‰Ωú
          </button>
        </div>
        
        <!-- AIËÅäÂ§©Èù¢ÊùøÂõ∫ÂÆöÂú®Âè≥‰æß -->
        <div class="flex items-center">
          <button
            @click="showChatPanel = !showChatPanel"
            :class="showChatPanel ? 'bg-blue-100 text-blue-700 border-blue-200' : 'text-gray-600 hover:text-gray-800 border-gray-200 hover:bg-gray-50'"
            class="flex items-center px-3 py-2 rounded-lg transition-colors duration-200 border text-sm"
            title="AI ËÅäÂ§©Âä©Êâã"
          >
            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
            </svg>
            AI Âä©Êâã
          </button>
        </div>
      </div>
    </div>
    
    <div class="flex flex-grow h-full relative">
      <!-- Â∑¶‰æßÈù¢ÊùøÂå∫Âüü -->
      <div class="flex">
        <!-- ÁâàÊú¨ÂéÜÂè≤Èù¢Êùø -->
        <div 
          v-if="showVersionHistory" 
          class="w-80 border-r border-gray-200 bg-white flex-shrink-0 z-10"
        >
          <version-history-panel
            :current-content="editorContent"
            :word-count="wordCount"
            @toggle-panel="showVersionHistory = false"
            @restore-version="handleRestoreVersion"
          />
        </div>
        
        <!-- ÂØºÂá∫Èù¢Êùø -->
        <div 
          v-if="showExportPanel" 
          class="w-80 border-r border-gray-200 bg-white flex-shrink-0 z-10"
        >
          <export-panel
            :document-content="editorContent"
            :word-count="wordCount"
            :references="references"
            @toggle-panel="showExportPanel = false"
          />
        </div>
        
        <!-- ÂºïÁî®ÁÆ°ÁêÜÈù¢Êùø -->
        <div 
          v-if="showCitationManager" 
          class="w-80 border-r border-gray-200 bg-white flex-shrink-0 z-10"
        >
          <citation-manager
            :references="references"
            @toggle-panel="showCitationManager = false"
            @add-reference="handleAddReference"
            @update-reference="handleUpdateReference"
            @delete-reference="handleDeleteReference"
            @insert-text="handleChatInsertText"
          />
        </div>
        
        <!-- Á†îÁ©∂Âä©ÊâãÈù¢Êùø -->
        <div 
          v-if="showResearchPanel" 
          class="w-80 border-r border-gray-200 bg-white flex-shrink-0 z-10"
        >
          <research-panel
            @toggle-panel="showResearchPanel = false"
            @add-reference="handleAddReference"
            @insert-text="handleChatInsertText"
          />
        </div>
        
        <!-- Ê®°ÊùøÈù¢Êùø -->
        <div 
          v-if="showTemplatesPanel" 
          class="w-80 border-r border-gray-200 bg-white flex-shrink-0 z-10"
        >
          <templates-panel
            @toggle-panel="showTemplatesPanel = false"
            @use-template="handleUseTemplate"
          />
        </div>
      </div>
      
      <!-- ‰∏ªÁºñËæëÂå∫Âüü -->
      <div class="flex-1 flex flex-col h-full overflow-hidden relative">
        <div class="flex-1 bg-white overflow-hidden relative">
          <text-editor
            ref="textEditorRef"
            :initial-content="editorContent"
            :auto-complete-enabled="false"
            :is-connected="isConnected.value"
            :references="references"
            @update:content="handleContentUpdate"
            @text-change="handleTextChange"
            @completion-accepted="handleCompletionAccepted"
            @completion-rejected="handleCompletionRejected"
            @selection-change="handleSelectionChange"
            @show-floating-toolbar="showFloatingToolbar"
            @hide-floating-toolbar="hideFloatingToolbar"
            @request-completion="handleRequestCompletion"
          />
          
          <!-- ÊµÆÂä®Â∑•ÂÖ∑Êù° -->
          <floating-toolbar
            :show="showFloatingMenu"
            :position="floatingMenuPosition"
            :selected-text="selectedText"
            :is-processing="isAiProcessing"
            :processing-type="aiProcessingType"
            @action="handleFloatingAction"
          />
        </div>
        
        <!-- Â∫ïÈÉ®Â∑•ÂÖ∑Ê†è -->
        <bottom-toolbar 
          :editor="textEditorRef?.editor"
          :is-connected="isConnected.value"
          :ai-status="aiStatus.value"
          :word-count="wordCount"
          @format="handleFormat"
        />
      </div>
      
      <!-- AI ËÅäÂ§©Âä©ÊâãÈù¢Êùø - Âõ∫ÂÆöÂè≥‰æß -->
      <div 
        v-if="showChatPanel" 
        class="w-80 border-l border-gray-200 bg-white flex-shrink-0 z-10"
      >
        <ai-chat-panel
          :is-connected="isConnected.value"
          :current-document="editorContent"
          @toggle-panel="showChatPanel = false"
          @insert-text="handleChatInsertText"
        />
      </div>
      
      <!-- Â§ßÁ∫≤ÁîüÊàêÂºπÂ±Ç -->
      <div 
        v-if="showOutlineGenerator" 
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
        @click="!isGeneratingOutline && (showOutlineGenerator = false)"
      >
        <div 
          class="bg-white rounded-lg p-6 max-w-md w-full mx-4 relative"
          @click.stop
        >
          <!-- Loading ÈÅÆÁΩ© -->
          <div 
            v-if="isGeneratingOutline"
            class="absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center rounded-lg z-10"
          >
            <div class="flex flex-col items-center">
              <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#4FD1C5]"></div>
              <p class="mt-2 text-sm text-gray-600">AIÊ≠£Âú®Êô∫ËÉΩÁîüÊàêÂ§ßÁ∫≤...</p>
            </div>
          </div>
          
          <h3 class="text-lg font-semibold mb-4">üéØ ÂºÄÂßãÊÇ®ÁöÑÂÜô‰Ωú‰πãÊóÖ</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ÂÜô‰Ωú‰∏ªÈ¢ò</label>
              <input 
                v-model="outlineTopicInput"
                type="text" 
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#4FD1C5]"
                placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÊÉ≥Ë¶ÅÂÜô‰ΩúÁöÑ‰∏ªÈ¢òÊàñÈóÆÈ¢ò"
                :disabled="isGeneratingOutline"
                @keyup.enter="!isGeneratingOutline && generateOutlineFromTopic()"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ÊñáÊ°£Á±ªÂûã</label>
              <select 
                v-model="selectedDocumentType" 
                :disabled="isGeneratingOutline"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#4FD1C5] disabled:bg-gray-100"
              >
                <option value="essay">ËÆ∫Êñá/ËÆ∫Ëø∞Êñá</option>
                <option value="research">Á†îÁ©∂Êä•Âëä</option>
                <option value="business">ÂïÜ‰∏öÊñáÊ°£</option>
                <option value="creative">ÂàõÊÑèÂÜô‰Ωú</option>
                <option value="technical">ÊäÄÊúØÊñáÊ°£</option>
              </select>
            </div>
            <div class="flex space-x-3">
              <button 
                @click="generateOutlineFromTopic"
                :disabled="!outlineTopicInput.trim() || isGeneratingOutline"
                class="flex-1 px-4 py-2 bg-[#4FD1C5] text-white rounded-md hover:bg-[#3DB9B0] disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center"
              >
                <span v-if="!isGeneratingOutline">ü§ñ AI ÁîüÊàêÂ§ßÁ∫≤</span>
                <span v-else class="flex items-center">
                  <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                  ÁîüÊàê‰∏≠...
                </span>
              </button>
              <button 
                @click="skipOutlineGeneration"
                :disabled="isGeneratingOutline"
                class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                Áõ¥Êé•ÂºÄÂßã
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, onBeforeUnmount, computed, watch } from 'vue'
import { useEditorStore } from '@/store/modules/editor'
import { useCompletion } from '@/composables/useCompletion'
import TextEditor from '@/components/editor/TextEditor.vue'
import AiChatPanel from '@/components/editor/AiChatPanel.vue'
import TemplatesPanel from '@/components/editor/TemplatesPanel.vue'
import ResearchPanel from '@/components/editor/ResearchPanel.vue'
import CitationManager from '@/components/editor/CitationManager.vue'
import ExportPanel from '@/components/editor/ExportPanel.vue'
import VersionHistoryPanel from '@/components/editor/VersionHistoryPanel.vue'
import BottomToolbar from '@/components/editor/BottomToolbar.vue'
import FloatingToolbar from '@/components/editor/FloatingToolbar.vue'
import { showSuccess, showError } from '@/utils/toast-service'

// ‰ΩøÁî®ÁºñËæëÂô®Áä∂ÊÄÅÁÆ°ÁêÜ
const editorStore = useEditorStore()

// ‰ΩøÁî®ÊñáÊú¨Ë°•ÂÖ®ÁªÑÂêàÂºèÂáΩÊï∞
const completion = useCompletion({
  wsUrl: 'ws://localhost:8000/api/v1/completion/ws',
  contextWindowBefore: 1536,
  contextWindowAfter: 256
})

// ÁºñËæëÂô®Áä∂ÊÄÅ
const textEditorRef = ref(null)
const editorContent = ref('<p>Ê¨¢Ëøé‰ΩøÁî®Â¢®‰∫ïÊô∫ËÉΩÂÜô‰ΩúÂä©ÊâãÔºÅ</p>')
const isConnected = computed(() => completion.isConnected)
const aiStatus = computed(() => completion.status)
const currentCompletion = ref('')

// UI Èù¢ÊùøÊéßÂà∂ - ÈªòËÆ§ÊâìÂºÄAIËÅäÂ§©ÂíåÂºïÁî®ÁÆ°ÁêÜ
const showChatPanel = ref(true) // AIËÅäÂ§©Èù¢ÊùøÈªòËÆ§ÊòæÁ§∫
const showTemplatesPanel = ref(false) // Ê®°ÊùøÈù¢ÊùøÊòæÁ§∫Áä∂ÊÄÅ  
const showResearchPanel = ref(false) // Á†îÁ©∂Èù¢ÊùøÊòæÁ§∫Áä∂ÊÄÅ
const showCitationManager = ref(true) // ÂºïÁî®ÁÆ°ÁêÜÈù¢ÊùøÈªòËÆ§ÊòæÁ§∫
const showExportPanel = ref(false) // ÂØºÂá∫Èù¢ÊùøÊòæÁ§∫Áä∂ÊÄÅ
const showVersionHistory = ref(false) // ÁâàÊú¨ÂéÜÂè≤Èù¢ÊùøÊòæÁ§∫Áä∂ÊÄÅ

// Â§ßÁ∫≤ÁîüÊàêÂô®Áä∂ÊÄÅ
const showOutlineGenerator = ref(false) // ÈªòËÆ§‰∏çÊòæÁ§∫Â§ßÁ∫≤ÁîüÊàêÂô®
const outlineTopicInput = ref('')
const selectedDocumentType = ref('essay')
const isGeneratingOutline = ref(false) // Ê∑ªÂä†Â§ßÁ∫≤ÁîüÊàêloadingÁä∂ÊÄÅ

// ÊµÆÂä®Â∑•ÂÖ∑Êù°Áä∂ÊÄÅ
const showFloatingMenu = ref(false)
const floatingMenuPosition = ref({ top: 0, left: 0 })
const selectedText = ref('')
const currentSelection = ref({ from: 0, to: 0 })

// AIÊìç‰ΩúloadingÁä∂ÊÄÅ
const isAiProcessing = ref(false)
const aiProcessingType = ref('') // ËÆ∞ÂΩïÂΩìÂâçÂ§ÑÁêÜÁöÑÁ±ªÂûã

// Â§ßÁ∫≤Áä∂ÊÄÅ
const outline = ref([])
const newOutlineItem = ref({
  title: '',
  level: 1
})

// ÂèÇËÄÉÊñáÁåÆÁä∂ÊÄÅ
const citationStyle = ref('apa')
const references = ref([])
const newReference = ref({
  author: '',
  title: '',
  publisher: '',
  year: ''
})
const canAddReference = computed(() => {
  return newReference.value.author && 
         newReference.value.title && 
         newReference.value.publisher && 
         newReference.value.year
})

// Â≠¶ÊúØÁªìÊûÑÁä∂ÊÄÅ
const paperType = ref('research')
const discipline = ref('science')
const academicTitle = ref('')
const structure = ref(null)
const formattedStructure = computed(() => {
  if (!structure.value) return ''
  
  // Â∞ÜÁªìÊûÑËΩ¨Êç¢‰∏∫HTML
  let html = `<h3 class="text-sm font-bold mb-2">${structure.value.title}</h3>`
  
  // Ê∑ªÂä†ÊëòË¶Å
  if (structure.value.abstract) {
    html += `<div class="mb-3">
      <h4 class="text-xs font-semibold mb-1">ÊëòË¶Å</h4>
      <p class="text-xs text-gray-700">${structure.value.abstract}</p>
    </div>`
  }
  
  // Ê∑ªÂä†Á´†ËäÇ
  if (structure.value.sections && structure.value.sections.length > 0) {
    html += `<div class="mb-3">
      <h4 class="text-xs font-semibold mb-1">Á´†ËäÇÁªìÊûÑ</h4>
      <ul class="list-disc pl-4 space-y-1 text-xs">`
    
    structure.value.sections.forEach(section => {
      html += `<li>
        <div class="font-medium">${section.title}</div>`
      
      if (section.description) {
        html += `<div class="text-xs text-gray-600">${section.description}</div>`
      }
      
      if (section.subsections && section.subsections.length > 0) {
        html += `<ul class="list-circle pl-4 mt-1 space-y-1">`
        section.subsections.forEach(subsection => {
          html += `<li>
            <div class="font-medium">${subsection.title}</div>`
          
          if (subsection.description) {
            html += `<div class="text-xs text-gray-600">${subsection.description}</div>`
          }
          
          html += `</li>`
        })
        html += `</ul>`
      }
      
      html += `</li>`
    })
    
    html += `</ul></div>`
  }
  
  return html
})

// Ê†∑ÂºèË∞ÉÊï¥Áä∂ÊÄÅÂ∑≤ÁßªÈô§

// ËÆ°ÁÆóÂ±ûÊÄß
const wordCount = computed(() => {
  // ‰ªéÁºñËæëÂô®ÂÜÖÂÆπ‰∏≠ÊèêÂèñÁ∫ØÊñáÊú¨Âπ∂ËÆ°ÁÆóÂ≠óÊï∞
  if (textEditorRef.value && textEditorRef.value.editor) {
    const text = textEditorRef.value.editor.getText()
    return text.replace(/\s+/g, '').length
  }
  return editorStore.wordCount || 0
})



// ÁõëÂê¨Ë°•ÂÖ®Áä∂ÊÄÅÂèòÂåñ
watch(() => completion.isConnected, (newValue) => {
  editorStore.setConnectionStatus(newValue)
})

watch(() => completion.status, (newValue) => {
  editorStore.updateAiStatus(newValue)
})

watch(() => completion.currentCompletion, (newValue) => {
  currentCompletion.value = newValue
  
  // Â¶ÇÊûúÊúâÊñ∞ÁöÑË°•ÂÖ®ÂÜÖÂÆπÔºåÊõ¥Êñ∞ÁºñËæëÂô®Áä∂ÊÄÅÁÆ°ÁêÜ‰∏≠ÁöÑË°•ÂÖ®ÊñáÊú¨
  if (newValue) {
    editorStore.updateCompletionText(newValue)
  }
  
  // Â¶ÇÊûúË°•ÂÖ®ÂÆåÊàêÔºåÊ∏ÖÈô§auto-completeÁöÑloadingÁä∂ÊÄÅ
  if (newValue && aiProcessingType.value === 'auto-complete') {
    isAiProcessing.value = false
    aiProcessingType.value = ''
  }
})

// ÁõëÂê¨ÁºñËæëÂô®Áä∂ÊÄÅÁÆ°ÁêÜ‰∏≠ÁöÑË°•ÂÖ®ÊñáÊú¨ÂèòÂåñ
watch(() => editorStore.completionText, (newValue) => {
  // Êõ¥Êñ∞ÂΩìÂâçË°•ÂÖ®ÂÜÖÂÆπ
  currentCompletion.value = newValue
})

// Â§ÑÁêÜËá™Âä®ÂÆåÊàêËØ∑Ê±Ç
const handleRequestCompletion = (data) => {
  // Ê£ÄÊü•AIËøûÊé•Áä∂ÊÄÅ
  if (!isConnected.value) {
    console.warn('AIÊúçÂä°Êú™ËøûÊé•ÔºåË∑≥ËøáËá™Âä®ÂÆåÊàêËØ∑Ê±Ç')
    return
  }
  
  // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂú®Â§ÑÁêÜ‰∏≠
  if (completion.isGenerating.value || aiStatus.value === 'processing') {
    console.log('Ê≠£Âú®Â§ÑÁêÜÂÖ∂‰ªñAIËØ∑Ê±ÇÔºåË∑≥ËøáËá™Âä®ÂÆåÊàê')
    return
  }
  
  // Ê£ÄÊü•ÊñáÊú¨ÂÜÖÂÆπÈïøÂ∫¶
  if (!data.text || data.text.length < 10) {
    console.log('ÊñáÊú¨ÂÜÖÂÆπËøáÁü≠ÔºåË∑≥ËøáËá™Âä®ÂÆåÊàê')
    return
  }
  
  // ‰ΩøÁî®completionÁªÑÂêàÂºèÂáΩÊï∞ËØ∑Ê±ÇËá™Âä®ÂÆåÊàê
  const success = completion.requestCompletion(
    data.text,
    data.contextBefore,
    data.contextAfter,
    data.cursorPosition
  )
  
  if (!success) {
    console.warn('Ëá™Âä®ÂÆåÊàêËØ∑Ê±ÇÂ§±Ë¥•')
  }
}

// Â§ÑÁêÜÁºñËæëÂô®ÂÜÖÂÆπÊõ¥Êñ∞
const handleContentUpdate = (content) => {
  editorContent.value = content
}

// Â§ÑÁêÜÊñáÊú¨ÂèòÂåñ
const handleTextChange = (text) => {
  // Êõ¥Êñ∞ÁºñËæëÂô®Áä∂ÊÄÅÁÆ°ÁêÜ‰∏≠ÁöÑÂÖâÊ†á‰ΩçÁΩÆ
  if (textEditorRef.value && textEditorRef.value.editor) {
    const { from } = textEditorRef.value.editor.state.selection
    editorStore.updateCursorPosition(from)
  }
}

// Â§ÑÁêÜË°•ÂÖ®Êé•Âèó
const handleCompletionAccepted = (completionText) => {
  // ÈÄöÁü•ÁºñËæëÂô®Áä∂ÊÄÅÁÆ°ÁêÜË°•ÂÖ®Â∑≤Êé•Âèó
  editorStore.acceptCompletion()
}

//Âá¶ÁêÜË°•ÂÖ®ÊãíÁªù
const handleCompletionRejected = () => {
  // ÈÄöÁü•ÁºñËæëÂô®Áä∂ÊÄÅÁÆ°ÁêÜË°•ÂÖ®Â∑≤ÊãíÁªù
  editorStore.rejectCompletion()
}

// Â§ÑÁêÜAIËÅäÂ§©Èù¢ÊùøÊèíÂÖ•ÊñáÊú¨
const handleChatInsertText = (text) => {
  const editor = textEditorRef.value?.editor
  if (!editor || !text) return
  
  // Âú®ÂΩìÂâçÂÖâÊ†á‰ΩçÁΩÆÊèíÂÖ•ÊñáÊú¨
  editor.chain().focus().insertContent(text).run()
  showSuccess('ÊñáÊú¨Â∑≤ÊèíÂÖ•')
}

// Â§ÑÁêÜ‰ΩøÁî®Ê®°Êùø
const handleUseTemplate = (template) => {
  const editor = textEditorRef.value?.editor
  if (!editor || !template?.content) return
  
  // ËÆæÁΩÆÁºñËæëÂô®ÂÜÖÂÆπ‰∏∫Ê®°ÊùøÂÜÖÂÆπ
  editor.commands.setContent(template.content)
  editorContent.value = template.content
  
  // ÂÖ≥Èó≠Ê®°ÊùøÈù¢Êùø
  showTemplatesPanel.value = false
  
  showSuccess(`Â∑≤Â∫îÁî®Ê®°Êùø: ${template.name}`)
}

// Â§ÑÁêÜÊ∑ªÂä†ÂºïÁî®
const handleAddReference = (reference) => {
  if (!reference) return
  
  // Ê∑ªÂä†Âà∞ÂºïÁî®ÂàóË°®
  references.value.push(reference)
  
  showSuccess(`Â∑≤Ê∑ªÂä†ÂºïÁî®: ${reference.title}`)
}

// Â§ÑÁêÜÊõ¥Êñ∞ÂºïÁî®
const handleUpdateReference = (index, reference) => {
  if (index >= 0 && index < references.value.length) {
    references.value[index] = reference
    showSuccess('ÂºïÁî®Â∑≤Êõ¥Êñ∞')
  }
}

// Â§ÑÁêÜÂà†Èô§ÂºïÁî®
const handleDeleteReference = (index) => {
  if (index >= 0 && index < references.value.length) {
    references.value.splice(index, 1)
    showSuccess('ÂºïÁî®Â∑≤Âà†Èô§')
  }
}

// Â§ÑÁêÜÁâàÊú¨ÊÅ¢Â§ç
const handleRestoreVersion = (content) => {
  const editor = textEditorRef.value?.editor
  if (!editor || !content) return
  
  // ËÆæÁΩÆÁºñËæëÂô®ÂÜÖÂÆπ‰∏∫ÊÅ¢Â§çÁöÑÁâàÊú¨
  editor.commands.setContent(content)
  editorContent.value = content
  
  // ÂÖ≥Èó≠ÁâàÊú¨ÂéÜÂè≤Èù¢Êùø
  showVersionHistory.value = false
  
  showSuccess('ÁâàÊú¨Â∑≤ÊÅ¢Â§ç')
}

// Ëé∑Âèñ‰∏ä‰∏ãÊñáÁ™óÂè£ÂÜÖÂÆπ
const getContextWindow = (editor) => {
  if (!editor) return { before: '', after: '' }
  
  const { state } = editor
  const { selection } = state
  const { from, to } = selection
  
  // Ëé∑ÂèñÂΩìÂâç‰ΩçÁΩÆ‰πãÂâçÁöÑÊñáÊú¨‰Ωú‰∏∫‰∏äÊñá
  const beforeText = state.doc.textBetween(0, from)
  
  // Ëé∑ÂèñÂΩìÂâç‰ΩçÁΩÆ‰πãÂêéÁöÑÊñáÊú¨‰Ωú‰∏∫‰∏ãÊñá
  const afterText = state.doc.textBetween(to, state.doc.content.size)
  
  return {
    before: beforeText,
    after: afterText
  }
}

// Ëé∑ÂèñÂ¢ûÂº∫ÁöÑ‰∏ä‰∏ãÊñáÁ™óÂè£ÂÜÖÂÆπ - Êõ¥Êô∫ËÉΩÁöÑ‰∏ä‰∏ãÊñáÊèêÂèñ
const getEnhancedContextWindow = (editor, cursorPosition) => {
  if (!editor) return { before: '', after: '' }
  
  const { state } = editor
  const text = state.doc.toString()
  
  // ËÆæÁΩÆ‰∏ä‰∏ãÊñáÁ™óÂè£Â§ßÂ∞èÔºàÂ≠óÁ¨¶Êï∞Ôºâ
  const beforeWindowSize = 1500  // ÂâçÊñá1500Â≠óÁ¨¶
  const afterWindowSize = 300    // ÂêéÊñá300Â≠óÁ¨¶
  
  // ËÆ°ÁÆóÂâçÊñáÂºÄÂßã‰ΩçÁΩÆ
  const beforeStart = Math.max(0, cursorPosition - beforeWindowSize)
  let beforeText = text.substring(beforeStart, cursorPosition)
  
  // Â¶ÇÊûúÂâçÊñáË¢´Êà™Êñ≠ÔºåÂ∞ΩÈáè‰ªéÂÆåÊï¥ÁöÑÂè•Â≠êÂºÄÂßã
  if (beforeStart > 0) {
    const sentenceStart = beforeText.search(/[„ÄÇÔºÅÔºü\n]\s*/)
    if (sentenceStart !== -1) {
      beforeText = beforeText.substring(sentenceStart + 1)
    }
  }
  
  // ËÆ°ÁÆóÂêéÊñáÁªìÊùü‰ΩçÁΩÆ
  const afterEnd = Math.min(text.length, cursorPosition + afterWindowSize)
  let afterText = text.substring(cursorPosition, afterEnd)
  
  // Â¶ÇÊûúÂêéÊñáË¢´Êà™Êñ≠ÔºåÂ∞ΩÈáèÂú®ÂÆåÊï¥ÁöÑÂè•Â≠êÁªìÊùü
  if (afterEnd < text.length) {
    const sentenceEnd = afterText.search(/[„ÄÇÔºÅÔºü\n]/)
    if (sentenceEnd !== -1) {
      afterText = afterText.substring(0, sentenceEnd + 1)
    }
  }
  
  return {
    before: beforeText.trim(),
    after: afterText.trim()
  }
}

// AIËæÖÂä©ÂäüËÉΩÂ§ÑÁêÜÊñπÊ≥ï
const handleAutoComplete = async () => {
  const editor = textEditorRef.value.editor
  if (!editor) return
  
  // Ê£ÄÊü•AIËøûÊé•Áä∂ÊÄÅ
  if (!isConnected.value) {
    showError('AIÊúçÂä°Êú™ËøûÊé•ÔºåÊó†Ê≥ï‰ΩøÁî®Ëá™Âä®ÂÆåÊàêÂäüËÉΩ')
    return
  }
  
  // Ëé∑ÂèñÂΩìÂâçÁºñËæëÂô®ÂÜÖÂÆπÂíåÂÖâÊ†á‰ΩçÁΩÆ
  const currentText = editor.getText()
  const { from } = editor.state.selection
  
  // Ê£ÄÊü•ÊòØÂê¶ÊúâË∂≥Â§üÁöÑÊñáÊú¨ÂÜÖÂÆπ
  if (!currentText.trim() || currentText.trim().length < 10) {
    showError('ËØ∑ËæìÂÖ•Êõ¥Â§öÊñáÊú¨ÂÜÖÂÆπ‰ª•‰ΩøÁî®Êô∫ËÉΩÁª≠ÂÜôÂäüËÉΩ')
    return
  }
  
  // ËÆæÁΩÆloadingÁä∂ÊÄÅ
  isAiProcessing.value = true
  aiProcessingType.value = 'auto-complete'
  
  try {
    // Ëé∑Âèñ‰∏ä‰∏ãÊñáÁ™óÂè£ - ÊîπËøõÁâàÊú¨ÔºåËé∑ÂèñÊõ¥Êô∫ËÉΩÁöÑ‰∏ä‰∏ãÊñá
    const contextWindow = getEnhancedContextWindow(editor, from)
    const { before, after } = contextWindow
    
    // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
    editorStore.updateAiStatus('Êô∫ËÉΩÁª≠ÂÜô‰∏≠...')
    
    // ËØ∑Ê±ÇÊñáÊú¨Ë°•ÂÖ®Ôºå‰º†ÈÄíÊõ¥ËØ¶ÁªÜÁöÑ‰∏ä‰∏ãÊñá‰ø°ÊÅØ
    completion.requestCompletion(currentText, before, after, from)
  } catch (error) {
    console.error('Êô∫ËÉΩÁª≠ÂÜôÂ§±Ë¥•:', error)
    showError('Êô∫ËÉΩÁª≠ÂÜôÂ§±Ë¥•ÔºåËØ∑ÈáçËØï')
  } finally {
    // Ê∏ÖÈô§loadingÁä∂ÊÄÅ
    isAiProcessing.value = false
    aiProcessingType.value = ''
  }
}

const handleSimplify = async () => {
  const editor = textEditorRef.value.editor
  if (!editor) return
  
  // Ê£ÄÊü•ÊòØÂê¶ÊúâÈÄâ‰∏≠ÊñáÊú¨
  const { from, to } = editor.state.selection
  if (from === to || !selectedText.value.trim()) {
    showError('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÁÆÄÂåñÁöÑÊñáÊú¨')
    return
  }
  
  // Ê£ÄÊü•AIËøûÊé•Áä∂ÊÄÅ
  if (!isConnected.value) {
    showError('AIÊúçÂä°Êú™ËøûÊé•ÔºåÊó†Ê≥ï‰ΩøÁî®ÁÆÄÂåñÂäüËÉΩ')
    return
  }
  
  // ËÆæÁΩÆloadingÁä∂ÊÄÅ
  isAiProcessing.value = true
  aiProcessingType.value = 'simplify'
  
  try {
    // Ë∞ÉÁî®ÂêéÁ´ØAPIËøõË°åÊñáÊú¨ÁÆÄÂåñ
    const response = await fetch('/api/v1/completion/optimize', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        text: selectedText.value,
        action: 'simplify',
        context_before: editor.state.doc.textBetween(0, from),
        context_after: editor.state.doc.textBetween(to, editor.state.doc.content.size)
      })
    })
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }
    
    const data = await response.json()
    
    if (data.completion) {
      // ÊõøÊç¢ÈÄâ‰∏≠ÁöÑÊñáÊú¨
      editor.chain().focus().deleteSelection().insertContent(data.completion).run()
      showSuccess('ÊñáÊú¨ÁÆÄÂåñÂÆåÊàê')
    } else {
      throw new Error('Êú™Êî∂Âà∞ÁÆÄÂåñÁªìÊûú')
    }
  } catch (error) {
    console.error('ÁÆÄÂåñÂ§±Ë¥•:', error)
    showError('ÁÆÄÂåñÂ§±Ë¥•ÔºåËØ∑ÈáçËØï')
  } finally {
    // Ê∏ÖÈô§loadingÁä∂ÊÄÅ
    isAiProcessing.value = false
    aiProcessingType.value = ''
  }
}

const handleRewrite = async () => {
  const editor = textEditorRef.value.editor
  if (!editor) return
  
  // Ê£ÄÊü•ÊòØÂê¶ÊúâÈÄâ‰∏≠ÊñáÊú¨
  const { from, to } = editor.state.selection
  if (from === to || !selectedText.value.trim()) {
    showError('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÊîπÂÜôÁöÑÊñáÊú¨')
    return
  }
  
  // Ê£ÄÊü•AIËøûÊé•Áä∂ÊÄÅ
  if (!isConnected.value) {
    showError('AIÊúçÂä°Êú™ËøûÊé•ÔºåÊó†Ê≥ï‰ΩøÁî®ÊîπÂÜôÂäüËÉΩ')
    return
  }
  
  // ËÆæÁΩÆloadingÁä∂ÊÄÅ
  isAiProcessing.value = true
  aiProcessingType.value = 'rewrite'
  
  try {
    // Ë∞ÉÁî®ÂêéÁ´ØAPIËøõË°åÊñáÊú¨ÊîπÂÜô
    const response = await fetch('/api/v1/completion/optimize', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        text: selectedText.value,
        action: 'rewrite',
        context_before: editor.state.doc.textBetween(0, from),
        context_after: editor.state.doc.textBetween(to, editor.state.doc.content.size)
      })
    })
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }
    
    const data = await response.json()
    
    if (data.completion) {
      // ÊõøÊç¢ÈÄâ‰∏≠ÁöÑÊñáÊú¨
      editor.chain().focus().deleteSelection().insertContent(data.completion).run()
      showSuccess('ÊñáÊú¨ÊîπÂÜôÂÆåÊàê')
    } else {
      throw new Error('Êú™Êî∂Âà∞ÊîπÂÜôÁªìÊûú')
    }
  } catch (error) {
    console.error('ÊîπÂÜôÂ§±Ë¥•:', error)
    showError('ÊîπÂÜôÂ§±Ë¥•ÔºåËØ∑ÈáçËØï')
  } finally {
    // Ê∏ÖÈô§loadingÁä∂ÊÄÅ
    isAiProcessing.value = false
    aiProcessingType.value = ''
  }
}

const handleExpand = async () => {
  const editor = textEditorRef.value.editor
  if (!editor) return
  
  // Ê£ÄÊü•ÊòØÂê¶ÊúâÈÄâ‰∏≠ÊñáÊú¨
  const { from, to } = editor.state.selection
  if (from === to || !selectedText.value.trim()) {
    showError('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÊâ©ÂÜôÁöÑÊñáÊú¨')
    return
  }
  
  // Ê£ÄÊü•AIËøûÊé•Áä∂ÊÄÅ
  if (!isConnected.value) {
    showError('AIÊúçÂä°Êú™ËøûÊé•ÔºåÊó†Ê≥ï‰ΩøÁî®Êâ©ÂÜôÂäüËÉΩ')
    return
  }
  
  // ËÆæÁΩÆloadingÁä∂ÊÄÅ
  isAiProcessing.value = true
  aiProcessingType.value = 'expand'
  
  try {
    // Ë∞ÉÁî®ÂêéÁ´ØAPIËøõË°åÊñáÊú¨Êâ©ÂÜô
    const response = await fetch('/api/v1/completion/optimize', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        text: selectedText.value,
        action: 'expand',
        context_before: editor.state.doc.textBetween(0, from),
        context_after: editor.state.doc.textBetween(to, editor.state.doc.content.size)
      })
    })
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }
    
    const data = await response.json()
    
    if (data.completion) {
      // ÊõøÊç¢ÈÄâ‰∏≠ÁöÑÊñáÊú¨
      editor.chain().focus().deleteSelection().insertContent(data.completion).run()
      showSuccess('ÊñáÊú¨Êâ©ÂÜôÂÆåÊàê')
    } else {
      throw new Error('Êú™Êî∂Âà∞Êâ©ÂÜôÁªìÊûú')
    }
  } catch (error) {
    console.error('Êâ©ÂÜôÂ§±Ë¥•:', error)
    showError('Êâ©ÂÜôÂ§±Ë¥•ÔºåËØ∑ÈáçËØï')
  } finally {
    // Ê∏ÖÈô§loadingÁä∂ÊÄÅ
    isAiProcessing.value = false
    aiProcessingType.value = ''
  }
}

const handleTranslate = async () => {
  const editor = textEditorRef.value.editor
  if (!editor) return
  
  // Ë∞ÉËØï‰ø°ÊÅØ
  console.log('=== ÁøªËØëÂäüËÉΩË¢´Ë∞ÉÁî® ===')
  console.log('Selected text:', selectedText.value)
  
  // Ê£ÄÊü•ÊòØÂê¶ÊúâÈÄâ‰∏≠ÊñáÊú¨
  const { from, to } = editor.state.selection
  if (from === to || !selectedText.value.trim()) {
    showError('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÁøªËØëÁöÑÊñáÊú¨')
    return
  }
  
  // Ê£ÄÊü•AIËøûÊé•Áä∂ÊÄÅ
  if (!isConnected.value) {
    showError('AIÊúçÂä°Êú™ËøûÊé•ÔºåÊó†Ê≥ï‰ΩøÁî®ÁøªËØëÂäüËÉΩ')
    return
  }
  
  // ËÆæÁΩÆloadingÁä∂ÊÄÅ
  isAiProcessing.value = true
  aiProcessingType.value = 'translate'
  
  try {
    // Ë∞ÉÁî®ÂêéÁ´ØAPIËøõË°åÊñáÊú¨ÁøªËØë
    console.log('=== ÂèëÈÄÅÁøªËØëËØ∑Ê±ÇÂà∞ÂêéÁ´Ø ===')
    console.log('Request body:', {
      text: selectedText.value,
      action: 'translate',
      context_before: editor.state.doc.textBetween(0, from),
      context_after: editor.state.doc.textBetween(to, editor.state.doc.content.size)
    })
    
    const response = await fetch('/api/v1/completion/optimize', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        text: selectedText.value,
        action: 'translate',
        context_before: editor.state.doc.textBetween(0, from),
        context_after: editor.state.doc.textBetween(to, editor.state.doc.content.size)
      })
    })
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }
    
    const data = await response.json()
    console.log('=== Êî∂Âà∞ÁøªËØëÂìçÂ∫î ===')
    console.log('Response data:', data)
    
    if (data.completion) {
      // ÊõøÊç¢ÈÄâ‰∏≠ÁöÑÊñáÊú¨
      editor.chain().focus().deleteSelection().insertContent(data.completion).run()
      showSuccess('ÊñáÊú¨ÁøªËØëÂÆåÊàê')
    } else {
      throw new Error('Êú™Êî∂Âà∞ÁøªËØëÁªìÊûú')
    }
  } catch (error) {
    console.error('ÁøªËØëÂ§±Ë¥•:', error)
    showError('ÁøªËØëÂ§±Ë¥•ÔºåËØ∑ÈáçËØï')
  } finally {
    // Ê∏ÖÈô§loadingÁä∂ÊÄÅ
    isAiProcessing.value = false
    aiProcessingType.value = ''
  }
}

// Â§ßÁ∫≤ÂäüËÉΩÊñπÊ≥ï
const hasChildren = (index) => {
  if (index >= outline.value.length - 1) return false
  return outline.value[index + 1].level > outline.value[index].level
}

const toggleExpand = (index) => {
  outline.value[index].expanded = !outline.value[index].expanded
}

const addOutlineItem = () => {
  if (!newOutlineItem.value.title.trim()) {
    showError('Ê†áÈ¢ò‰∏çËÉΩ‰∏∫Á©∫')
    return
  }
  
  outline.value.push({
    title: newOutlineItem.value.title,
    level: newOutlineItem.value.level,
    expanded: true
  })
  
  newOutlineItem.value.title = ''
  showSuccess('Êù°ÁõÆÂ∑≤Ê∑ªÂä†')
}

const editOutlineItem = (index) => {
  newOutlineItem.value.title = outline.value[index].title
  newOutlineItem.value.level = outline.value[index].level
  
  // Âà†Èô§ÂéüÊù°ÁõÆ
  outline.value.splice(index, 1)
}

const deleteOutlineItem = (index) => {
  outline.value.splice(index, 1)
  showSuccess('Êù°ÁõÆÂ∑≤Âà†Èô§')
}

/**
 * Ê†πÊçÆ‰∏ªÈ¢òÁîüÊàêÂ§ßÁ∫≤ - ÊîπËøõÁâà
 */
const generateOutlineFromTopic = async () => {
  if (!outlineTopicInput.value.trim()) {
    showError('ËØ∑ËæìÂÖ•ÊñáÁ´†‰∏ªÈ¢ò')
    return
  }
  
  if (isGeneratingOutline.value) {
    return // Èò≤Ê≠¢ÈáçÂ§çËØ∑Ê±Ç
  }
  
  try {
    // ÂºÄÂßãloadingÁä∂ÊÄÅ
    isGeneratingOutline.value = true
    
    // ÂáÜÂ§áËØ∑Ê±ÇÊï∞ÊçÆ
    const requestData = {
      topic: outlineTopicInput.value.trim(),
      paper_type: selectedDocumentType.value || 'essay',
      discipline: 'general'  // ÂèØ‰ª•Ê†πÊçÆÁî®Êà∑ÈÄâÊã©Ë∞ÉÊï¥
    }
    
    console.log('ÂèëÈÄÅÂ§ßÁ∫≤ÁîüÊàêËØ∑Ê±Ç:', requestData)
    
    // Ë∞ÉÁî®ÂêéÁ´ØAPIÁîüÊàêÂ§ßÁ∫≤
    const response = await fetch('/api/v1/academic/outline', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(requestData)
    })
    
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}))
      throw new Error(errorData.detail || `HTTP error! status: ${response.status}`)
    }
    
    const data = await response.json()
    console.log('Êî∂Âà∞Â§ßÁ∫≤Êï∞ÊçÆ:', data)
    
    // È™åËØÅËøîÂõûÁöÑÊï∞ÊçÆÊ†ºÂºè
    if (!data.outline || !Array.isArray(data.outline)) {
      throw new Error('ËøîÂõûÁöÑÂ§ßÁ∫≤Êï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°Æ')
    }
    
    // ËΩ¨Êç¢APIÂìçÂ∫î‰∏∫ÂâçÁ´ØÊ†ºÂºè
    outline.value = data.outline.map((item, index) => ({
      title: item.title || `Á´†ËäÇ ${index + 1}`,
      level: item.level || 1,
      description: item.description || '',
      expanded: true
    }))
    
    // ÂÖ≥Èó≠ÁîüÊàêÂØπËØùÊ°Ü
    showOutlineGenerator.value = false
    showSuccess('Â§ßÁ∫≤ÁîüÊàêÂÆåÊàêÔºÅÊ≠£Âú®Â∫îÁî®Âà∞ÊñáÊ°£...')
    
    // Âª∂Ëøü‰∏Ä‰∏ãÂÜçÂ∫îÁî®Â§ßÁ∫≤Âà∞ÊñáÊ°£ÔºåÁªôÁî®Êà∑Êó∂Èó¥ÁúãÂà∞ÊàêÂäü‰ø°ÊÅØ
    setTimeout(() => {
      applyOutlineToDocument()
    }, 500)
    
  } catch (error) {
    console.error('ÁîüÊàêÂ§ßÁ∫≤Â§±Ë¥•:', error)
    showError(`ÁîüÊàêÂ§ßÁ∫≤Â§±Ë¥•: ${error.message}`)
  } finally {
    // ÁªìÊùüloadingÁä∂ÊÄÅ
    isGeneratingOutline.value = false
  }
}

/**
 * Ë∑≥ËøáÂ§ßÁ∫≤ÁîüÊàê
 */
const skipOutlineGeneration = () => {
  showOutlineGenerator.value = false
  showSuccess('Â∑≤Ë∑≥ËøáÂ§ßÁ∫≤ÁîüÊàêÔºåÂèØÈöèÊó∂Âú®‰æßËæπÊ†èÈáçÊñ∞ÁîüÊàê')
}

/**
 * Â§ÑÁêÜÂ∑•ÂÖ∑Êù°AIÊìç‰Ωú
 */
const handleToolbarAiAction = (action) => {
  switch (action) {
    case 'auto-complete':
      handleAutoComplete()
      break
    case 'rewrite':
      handleRewrite()
      break
    case 'expand':
      handleExpand()
      break
    case 'simplify':
      handleSimplify()
      break
    default:
      console.warn('Êú™Áü•ÁöÑAIÊìç‰Ωú:', action)
  }
}

/**
 * Â§ÑÁêÜÂ∑•ÂÖ∑Êù°ÂèÇËÄÉÊñáÁåÆÊìç‰Ωú
 */
const handleToolbarReferenceAction = (action) => {
  switch (action) {
    case 'add':
      // ÊòæÁ§∫Ê∑ªÂä†ÂºïÁî®ÊèêÁ§∫
      showSuccess('ËØ∑Ê∑ªÂä†ÂºïÁî®‰ø°ÊÅØ')
      break
    case 'insert':
      // ÊèíÂÖ•Â∑≤ÊúâÁöÑÂºïÁî®
      if (references.value.length === 0) {
        showError('ÊöÇÊó†ÂèØÊèíÂÖ•ÁöÑÂºïÁî®ÔºåËØ∑ÂÖàÊ∑ªÂä†ÂºïÁî®')
        return
      }
      // ÊèíÂÖ•Á¨¨‰∏Ä‰∏™ÂºïÁî®‰Ωú‰∏∫Á§∫‰æãÔºåÂÆûÈôÖÂ∫îËØ•ËÆ©Áî®Êà∑ÈÄâÊã©
      insertCitation(references.value[0])
      break
    case 'format':
      // Ê†ºÂºèÂåñÊâÄÊúâÂºïÁî®
      showSuccess('ÂºïÁî®Ê†ºÂºèÂ∑≤Êõ¥Êñ∞')
      break
    default:
      console.warn('Êú™Áü•ÁöÑÂèÇËÄÉÊñáÁåÆÊìç‰Ωú:', action)
  }
}

const generateOutlineFromDocument = () => {
  const editor = textEditorRef.value.editor
  if (!editor) return
  
  const content = editor.getText()
  
  // ËøôÈáåÂèØ‰ª•Ë∞ÉÁî®ÂêéÁ´ØAPIÊù•ÁîüÊàêÂ§ßÁ∫≤
  // Ê®°ÊãüÁîüÊàêÂ§ßÁ∫≤
  setTimeout(() => {
    // ÂÅáËÆæËøôÊòØ‰ªéAPIËøîÂõûÁöÑÂ§ßÁ∫≤
    outline.value = [
      { title: 'ÂºïË®Ä', level: 1, expanded: true },
      { title: 'Á†îÁ©∂ËÉåÊôØ', level: 2, expanded: true },
      { title: 'Á†îÁ©∂ÊÑè‰πâ', level: 2, expanded: true },
      { title: 'ÊñáÁåÆÁªºËø∞', level: 1, expanded: true },
      { title: 'Á†îÁ©∂ÊñπÊ≥ï', level: 1, expanded: true },
      { title: 'Êï∞ÊçÆÊî∂ÈõÜ', level: 2, expanded: true },
      { title: 'Êï∞ÊçÆÂàÜÊûê', level: 2, expanded: true },
      { title: 'Á†îÁ©∂ÁªìÊûú', level: 1, expanded: true },
      { title: 'ËÆ®ËÆ∫', level: 1, expanded: true },
      { title: 'ÁªìËÆ∫‰∏éÂ±ïÊúõ', level: 1, expanded: true }
    ]
    
    showSuccess('Â∑≤‰ªéÊñáÊ°£ÁîüÊàêÂ§ßÁ∫≤')
  }, 1000)
}

// Â§ÑÁêÜÊñáÊú¨ÈÄâÊã©ÂèòÂåñ
const handleSelectionChange = (selection) => {
  selectedText.value = selection.text
  currentSelection.value = { from: selection.from, to: selection.to }
}

// ÊòæÁ§∫ÊµÆÂä®Â∑•ÂÖ∑Êù°
const showFloatingToolbar = (data) => {
  showFloatingMenu.value = true
  floatingMenuPosition.value = data.position
  selectedText.value = data.selectedText
  currentSelection.value = data.selectionRange
}

// ÈöêËóèÊµÆÂä®Â∑•ÂÖ∑Êù°
const hideFloatingToolbar = () => {
  showFloatingMenu.value = false
  selectedText.value = ''
}

// Â§ÑÁêÜÊµÆÂä®Â∑•ÂÖ∑Êù°Êìç‰Ωú
const handleFloatingAction = (action) => {
  const editor = textEditorRef.value?.editor
  if (!editor || !selectedText.value) return
  
  switch (action) {
    case 'auto-complete':
      handleAutoComplete()
      break
    case 'rewrite':
      handleRewrite()
      break
    case 'expand':
      handleExpand()
      break
    case 'simplify':
      handleSimplify()
      break
    case 'translate':
      handleTranslate()
      break
    case 'insert-reference':
      if (references.value.length > 0) {
        insertCitation(references.value[0])
      } else {
        showError('ÊöÇÊó†ÂèØÊèíÂÖ•ÁöÑÂºïÁî®ÔºåËØ∑ÂÖàÊ∑ªÂä†ÂºïÁî®')
      }
      break
    default:
      console.warn('Êú™Áü•ÁöÑÊµÆÂä®Â∑•ÂÖ∑Êù°Êìç‰Ωú:', action)
  }
  
  // ÈöêËóèÊµÆÂä®Â∑•ÂÖ∑Êù°
  hideFloatingToolbar()
}

// ‰ªéÈÄâ‰∏≠ÊñáÊú¨ÁîüÊàêÂ§ßÁ∫≤
const generateOutlineFromText = (text) => {
  // ËøôÈáåÂèØ‰ª•Ë∞ÉÁî®ÂêéÁ´ØAPIÊù•ÁîüÊàêÂ§ßÁ∫≤
  console.log('Ê≠£Âú®‰ªéÈÄâ‰∏≠ÊñáÊú¨ÁîüÊàêÂ§ßÁ∫≤:', text)
  showSuccess('Ê≠£Âú®ÁîüÊàêÂ§ßÁ∫≤...')
}

const applyOutlineToDocument = () => {
  const editor = textEditorRef.value?.editor
  if (!editor || outline.value.length === 0) return
  
  try {
    // ÁîüÊàêÁªìÊûÑÂåñÁöÑÂ§ßÁ∫≤HTML
    let outlineHtml = ''
    
    outline.value.forEach(item => {
      const level = Math.min(Math.max(item.level, 1), 6) // Á°Æ‰øùlevelÂú®1-6‰πãÈó¥
      const tagName = `h${level}`
      
      // Ê∑ªÂä†Ê†áÈ¢ò
      outlineHtml += `<${tagName}>${item.title}</${tagName}>`
      
      // Â¶ÇÊûúÊúâÊèèËø∞ÔºåÊ∑ªÂä†ÊèèËø∞ÊÆµËêΩ
      if (item.description && item.description.trim()) {
        outlineHtml += `<p style="color: #666; font-style: italic; margin-bottom: 10px;">${item.description}</p>`
      }
      
      // ‰∏∫ÊØè‰∏™Á´†ËäÇÊ∑ªÂä†ÂÜÖÂÆπÂç†‰ΩçÁ¨¶
      if (level <= 2) {
        outlineHtml += `<p>ËØ∑Âú®Ê≠§Â§ÑÂ±ïÂºÄ"${item.title}"ÁöÑÂÖ∑‰ΩìÂÜÖÂÆπ...</p>`
      }
      
      // Ê∑ªÂä†ÈÄÇÂΩìÁöÑÁ©∫Ë°å
      outlineHtml += `<p><br></p>`
    })
    
    // Â¶ÇÊûúÊ≤°ÊúâÁîüÊàê‰ªª‰ΩïHTMLÔºåÂàõÂª∫ÈªòËÆ§ÂÜÖÂÆπ
    if (!outlineHtml.trim()) {
      outlineHtml = '<h1>Ê¨¢Ëøé‰ΩøÁî®Â¢®‰∫ïÊô∫ËÉΩÂÜô‰ΩúÂä©Êâã</h1><p>ËØ∑ÂºÄÂßãÊÇ®ÁöÑÂÜô‰Ωú‰πãÊóÖ...</p>'
    }
    
    // ËÆæÁΩÆÁºñËæëÂô®ÂÜÖÂÆπ
    editor.commands.setContent(outlineHtml)
    
    // Êõ¥Êñ∞ÂÜÖÂÆπÁä∂ÊÄÅ
    editorContent.value = outlineHtml
    
    showSuccess('Â§ßÁ∫≤Â∑≤ÊàêÂäüÂ∫îÁî®Âà∞ÊñáÊ°£ÔºåÊÇ®ÂèØ‰ª•ÂºÄÂßãÂü∫‰∫éÂ§ßÁ∫≤ËøõË°åÂÜô‰Ωú‰∫ÜÔºÅ')
    
  } catch (error) {
    console.error('Â∫îÁî®Â§ßÁ∫≤Âà∞ÊñáÊ°£Â§±Ë¥•:', error)
    showError('Â∫îÁî®Â§ßÁ∫≤Âà∞ÊñáÊ°£Â§±Ë¥•ÔºåËØ∑ÈáçËØï')
  }
}

// ÂèÇËÄÉÊñáÁåÆÂäüËÉΩÊñπÊ≥ï
const addReference = () => {
  if (!canAddReference.value) {
    showError('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑÂºïÁî®‰ø°ÊÅØ')
    return
  }
  
  references.value.push({...newReference.value})
  
  // Ê∏ÖÁ©∫Ë°®Âçï
  newReference.value = {
    author: '',
    title: '',
    publisher: '',
    year: ''
  }
  
  showSuccess('ÂºïÁî®Â∑≤Ê∑ªÂä†')
}

const deleteReference = (index) => {
  references.value.splice(index, 1)
  showSuccess('ÂºïÁî®Â∑≤Âà†Èô§')
}

const formatCitation = (reference) => {
  // Ê†πÊçÆÈÄâÊã©ÁöÑÂºïÁî®Ê†∑ÂºèÊ†ºÂºèÂåñÂºïÁî®
  switch (citationStyle.value) {
    case 'apa':
      return `${reference.author}. (${reference.year}). ${reference.title}. ${reference.publisher}.`
    case 'mla':
      return `${reference.author}. "${reference.title}." ${reference.publisher}, ${reference.year}.`
    case 'chicago':
      return `${reference.author}, "${reference.title}," ${reference.publisher}, ${reference.year}.`
    case 'harvard':
      return `${reference.author} (${reference.year}) ${reference.title}. ${reference.publisher}.`
    default:
      return `${reference.author} (${reference.year}). ${reference.title}. ${reference.publisher}.`
  }
}

const insertCitation = (reference) => {
  const editor = textEditorRef.value.editor
  if (!editor) return
  
  // Ê†πÊçÆÂºïÁî®Ê†∑ÂºèÁîüÊàêÂÜÖËÅîÂºïÁî®
  let citationText = ''
  switch (citationStyle.value) {
    case 'apa':
      citationText = `(${reference.author}, ${reference.year})`
      break
    case 'mla':
      citationText = `(${reference.author} ${reference.year})`
      break
    case 'chicago':
      citationText = `(${reference.author} ${reference.year})`
      break
    case 'harvard':
      citationText = `(${reference.author}, ${reference.year})`
      break
    default:
      citationText = `(${reference.author}, ${reference.year})`
  }
  
  // ÊèíÂÖ•Âà∞ÁºñËæëÂô®ÂΩìÂâç‰ΩçÁΩÆ
  editor.commands.insertContent(citationText)
  showSuccess('ÂºïÁî®Â∑≤ÊèíÂÖ•')
}

/**
 * ÁîüÊàêÂ≠¶ÊúØÁªìÊûÑ
 */
const generateStructure = async () => {
  if (!academicTitle.value) {
    showError('ËØ∑ËæìÂÖ•ËÆ∫ÊñáÊ†áÈ¢ò')
    return
  }
  
  try {
    showSuccess('Ê≠£Âú®ÁîüÊàêËÆ∫ÊñáÁªìÊûÑ...')
    
    // Ë∞ÉÁî®ÂêéÁ´ØAPIÁîüÊàêÂ≠¶ÊúØÁªìÊûÑ
    const response = await fetch('/api/v1/academic/structure', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        title: academicTitle.value,
        paper_type: paperType.value || 'research',
        discipline: discipline.value || 'science',
        citation_style: citationStyle.value || 'apa'
      })
    })
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }
    
    const data = await response.json()
    structure.value = data
    
    showSuccess('ËÆ∫ÊñáÁªìÊûÑÁîüÊàêÂÆåÊàêÔºÅ')
  } catch (error) {
    console.error('ÁîüÊàêËÆ∫ÊñáÁªìÊûÑÂ§±Ë¥•:', error)
    showError('ÁîüÊàêËÆ∫ÊñáÁªìÊûÑÂ§±Ë¥•ÔºåËØ∑ÈáçËØï')
  }
}

const applyStructureToDocument = () => {
  const editor = textEditorRef.value.editor
  if (!editor || !structure.value) return
  
  // ÁîüÊàêÁªìÊûÑHTML
  let structureHtml = `<h1>${structure.value.title}</h1>\n`
  structureHtml += `<h2>ÊëòË¶Å</h2>\n<p>${structure.value.abstract}</p>\n`
  
  // Ê∑ªÂä†Á´†ËäÇ
  structure.value.sections.forEach(section => {
    structureHtml += `<h2>${section.title}</h2>\n`
    structureHtml += `<p>${section.description}</p>\n`
    
    if (section.subsections && section.subsections.length > 0) {
      section.subsections.forEach(subsection => {
        structureHtml += `<h3>${subsection.title}</h3>\n`
        structureHtml += `<p>${subsection.description}</p>\n`
      })
    }
  })
  
  // ÊèíÂÖ•Âà∞ÁºñËæëÂô®
  editor.commands.setContent(structureHtml)
  showSuccess('Â∑≤Â∫îÁî®ËÆ∫ÊñáÁªìÊûÑÂà∞ÊñáÊ°£')
}

// Ê†∑ÂºèË∞ÉÊï¥ÂäüËÉΩÊñπÊ≥ïÂ∑≤ÁßªÈô§

/**
 * Â§ÑÁêÜÂ§ßÁ∫≤ÁîüÊàê‰∫ã‰ª∂
 */
const handleOutlineGenerate = (topic) => {
  generateOutlineFromTopic(topic)
}



/**
 * Â§ÑÁêÜÊ†ºÂºèÂåñ‰∫ã‰ª∂
 */
const handleFormat = (formatType) => {
  const editor = textEditorRef.value?.editor
  if (!editor) return
  
  switch (formatType) {
    case 'heading1':
      editor.chain().focus().toggleHeading({ level: 1 }).run()
      break
    case 'heading2':
      editor.chain().focus().toggleHeading({ level: 2 }).run()
      break
    case 'heading3':
      editor.chain().focus().toggleHeading({ level: 3 }).run()
      break
    case 'bold':
      editor.chain().focus().toggleBold().run()
      break
    case 'italic':
      editor.chain().focus().toggleItalic().run()
      break
    case 'underline':
      editor.chain().focus().toggleUnderline().run()
      break
    case 'strike':
      editor.chain().focus().toggleStrike().run()
      break
    case 'bulletList':
      editor.chain().focus().toggleBulletList().run()
      break
    case 'orderedList':
      editor.chain().focus().toggleOrderedList().run()
      break
    case 'blockquote':
      editor.chain().focus().toggleBlockquote().run()
      break
    case 'codeBlock':
      editor.chain().focus().toggleCodeBlock().run()
      break
    case 'alignLeft':
      editor.chain().focus().setTextAlign('left').run()
      break
    case 'alignCenter':
      editor.chain().focus().setTextAlign('center').run()
      break
    case 'alignRight':
      editor.chain().focus().setTextAlign('right').run()
      break
    case 'horizontalRule':
      editor.chain().focus().setHorizontalRule().run()
      break
    default:
      console.warn('Êú™Áü•ÁöÑÊ†ºÂºèÂåñÁ±ªÂûã:', formatType)
  }
}

/**
 * Â§ÑÁêÜAIÊìç‰Ωú
 */
const handleAiAction = (action) => {
  if (action.type === 'outline-generate') {
    outlineTopicInput.value = action.topic
    generateOutlineFromTopic()
  } else {
    console.warn('Êú™Áü•ÁöÑAIÊìç‰Ωú:', action)
  }
}

// ÁîüÂëΩÂë®ÊúüÈí©Â≠ê
onMounted(() => {
  // WebSocketËøûÊé•Â∑≤ÁªèÂú®useCompletion‰∏≠Ëá™Âä®Âª∫Á´ã
})

onBeforeUnmount(() => {
  // Êñ≠ÂºÄWebSocketËøûÊé•
  completion.disconnect()
})
</script>

<style scoped>
.outline-tree {
  max-height: 300px; /* Â¢ûÂä†Â§ßÁ∫≤Ê†ëÁöÑÈ´òÂ∫¶ */
  overflow-y: auto;
}

.outline-item {
  border-bottom: 1px solid #eee;
}

.references-list {
  max-height: 300px; /* Â¢ûÂä†ÂèÇËÄÉÊñáÁåÆÂàóË°®ÁöÑÈ´òÂ∫¶ */
  overflow-y: auto;
}

:deep(.ProseMirror) {
  min-height: 600px; /* Â¢ûÂä†ÁºñËæëÂô®ÁöÑÊúÄÂ∞èÈ´òÂ∫¶ */
  padding: 1rem;
}

/* Á°Æ‰øùÁºñËæëÂô®Âå∫ÂüüÂç†ÊçÆÊõ¥Â§öÁ©∫Èó¥ */
.min-h-screen {
  min-height: 100vh;
}
</style>
